import sqlite3
import logging
import json
import os
from typing import List, Dict

logger = logging.getLogger(__name__)

class ChatDatabase:
    def __init__(self, db_path: str = "data/chat_history.db"):
        # Создаем папку data если её нет
        os.makedirs(os.path.dirname(db_path), exist_ok=True)
        self.db_path = db_path
        self.init_database()

    def init_database(self):
        """Инициализация базы данных"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            # Таблица для хранения сообщений чата
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS chat_messages (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    chat_id INTEGER NOT NULL,
                    user_id INTEGER NOT NULL,
                    username TEXT,
                    message_text TEXT NOT NULL,
                    message_type TEXT DEFAULT 'text',
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                    is_bot_message BOOLEAN DEFAULT FALSE
                )
            ''')
            
            # Таблица для контекста чатов
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS chat_context (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    chat_id INTEGER UNIQUE NOT NULL,
                    last_topics TEXT,
                    key_entities TEXT,
                    last_activity DATETIME DEFAULT CURRENT_TIMESTAMP,
                    summary TEXT
                )
            ''')
            
            # Индексы для ускорения поиска
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_chat_messages_chat_id ON chat_messages(chat_id)')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_chat_messages_timestamp ON chat_messages(timestamp)')
            
            conn.commit()
            conn.close()
            logger.info("Database initialized successfully")
            
        except Exception as e:
            logger.error(f"Error initializing database: {e}")
            raise

    def save_message(self, chat_id: int, user_id: int, username: str, 
                    message_text: str, is_bot_message: bool = False,
                    message_type: str = 'text'):
        """Сохранение сообщения в базу данных"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO chat_messages 
                (chat_id, user_id, username, message_text, is_bot_message, message_type)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (chat_id, user_id, username, message_text, is_bot_message, message_type))
            
            # Обновляем время последней активности чата
            cursor.execute('''
                INSERT OR REPLACE INTO chat_context 
                (chat_id, last_activity) 
                VALUES (?, CURRENT_TIMESTAMP)
            ''', (chat_id,))
            
            conn.commit()
            message_id = cursor.lastrowid
            conn.close()
            
            logger.debug(f"Message saved: chat_id={chat_id}, user_id={user_id}, text={message_text[:50]}...")
            return message_id
            
        except Exception as e:
            logger.error(f"Error saving message: {e}")
            return None

    def get_chat_history(self, chat_id: int, limit: int = 50) -> List[Dict]:
        """Получение истории чата"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT username, message_text, timestamp, is_bot_message
                FROM chat_messages 
                WHERE chat_id = ? 
                ORDER BY timestamp DESC 
                LIMIT ?
            ''', (chat_id, limit))
            
            messages = []
            for row in cursor.fetchall():
                messages.append({
                    'username': row[0],
                    'text': row[1],
                    'timestamp': row[2],
                    'is_bot': bool(row[3])
                })
            
            conn.close()
            return list(reversed(messages))  # Возвращаем в хронологическом порядке
            
        except Exception as e:
            logger.error(f"Error getting chat history: {e}")
            return []

    def search_messages(self, chat_id: int, query: str, limit: int = 10) -> List[Dict]:
        """Поиск сообщений по ключевым словам"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT username, message_text, timestamp
                FROM chat_messages 
                WHERE chat_id = ? AND message_text LIKE ?
                ORDER BY timestamp DESC 
                LIMIT ?
            ''', (chat_id, f'%{query}%', limit))
            
            results = []
            for row in cursor.fetchall():
                results.append({
                    'username': row[0],
                    'text': row[1],
                    'timestamp': row[2]
                })
            
            conn.close()
            return results
            
        except Exception as e:
            logger.error(f"Error searching messages: {e}")
            return []

    def get_chat_summary(self, chat_id: int) -> Dict:
        """Получение сводки по чату"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            # Статистика чата
            cursor.execute('''
                SELECT 
                    COUNT(*) as total_messages,
                    COUNT(DISTINCT user_id) as unique_users,
                    MIN(timestamp) as first_message,
                    MAX(timestamp) as last_message
                FROM chat_messages 
                WHERE chat_id = ?
            ''', (chat_id,))
            
            stats = cursor.fetchone()
            
            # Самые активные пользователи
            cursor.execute('''
                SELECT username, COUNT(*) as message_count
                FROM chat_messages 
                WHERE chat_id = ?
                GROUP BY username 
                ORDER BY message_count DESC 
                LIMIT 5
            ''', (chat_id,))
            
            top_users = [{'username': row[0], 'count': row[1]} for row in cursor.fetchall()]
            
            conn.close()
            
            return {
                'total_messages': stats[0] if stats else 0,
                'unique_users': stats[1] if stats else 0,
                'first_message': stats[2] if stats else None,
                'last_message': stats[3] if stats else None,
                'top_users': top_users,
                'top_keywords': []
            }
            
        except Exception as e:
            logger.error(f"Error getting chat summary: {e}")
            return {}

    def clear_chat_history(self, chat_id: int):
        """Очистка истории чата"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('DELETE FROM chat_messages WHERE chat_id = ?', (chat_id,))
            cursor.execute('DELETE FROM chat_context WHERE chat_id = ?', (chat_id,))
            
            conn.commit()
            conn.close()
            logger.info(f"Cleared history for chat {chat_id}")
            
        except Exception as e:
            logger.error(f"Error clearing chat history: {e}")